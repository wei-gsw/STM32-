#STM32车载多媒体播放器

方案一：此方案采用 89C51 单片机实现，单片机软件编程自由度大，可用编程实现各种控制算法和逻辑控制。
但是 89C51 需外接模数转换器来满足数据采样。如果系统增加语音播放功能，还需外接语音芯片，对外围电路来说，比较复杂，且软件实现也较麻烦。另外，51 单片机需要用仿真器来实现软硬件调试，较为繁琐。
方案二:此方案采用 SPCE061A 单片机实现，此单片机内置 8 路 ADC，2 路 DAC，且集成开发环境中，配有很多语音播放函数，用 SPCE061A 实现语音播放相对方便。但5V的工作电压，16位的处理器芯片，较低的闪存，使得功耗比较大，处理速度比较慢，工作效率比较低，存储量受到限制。
方案三：此方案采用STM32F103VCT6实现，它使用高性能的ARM Cortex-M3 32位的RISC内核，工作频率为72MHz，内置高速存储器(高达128K字节的闪存和20K字节的SRAM)，丰富的增强型I/O端口以及包含2个12位的ADC、3个通用16位定时器和一个PWM定时器。使得处理速度大大提高，机器功耗大大降低，整体性能得到很大提高。32位的处理器使得控制更加稳定、迅速，窗口型看门狗，使得程序运行更加高效。另外，比较方便的是该板支持硬件仿真，通过Ulink仿真器可以方便实现在线逐步调试，这大大方便了系统的开发与调试工作。
基于STM32的高性能，低功耗，方便调试等特性，故选择方案三。
1.1.1	MP3解码方案 
方案一: 此方案采用软解MP3，直接用软件解码。节约了硬件成本，但代码复杂，编程难度较高，工作量极大，而且对控制器的处理速度和资源要求都比较高。
方案二：此方案采用硬解MP3，直接用音频解码芯片解码。它使用高性能的VS1003 MP3解码芯片，功能强大而且价格便宜，VS1003支持MP3、WAV、WMA、MIDI等诸多音频格式，音质可与市场上中档MP3播放器相媲美。
基于上述比较，故选择方案二；
1.1.2	显示模块方案 
方案一：此方案采用LCD1602，完成数据显示。LCD1602驱动电路简单，它可以显示简单的中英文字符，功能和设计的成本都比较低！
方案二：此方案采用LCD12864,它既可以显示中英文字符，也可以显示图片。但其图案分辨率较低，而且只能显示单色字符。
方案三：此方案采用TFT液晶模块，它既可以显示彩色数字、中英文字符和图案，还可以加上触摸屏模块，实现GUI用户图形交互实时控制！
基于TFT液晶的强大功能，故选择方案三。
1.1.3	MP3储存介质方案
方案一：此方案采用直接将MP3文件存放在控制器的内部ROM储存器中，读取速度快，操作简单方便。但是，相比于51,AVR, SPCE061A等单片机，虽然STM32有着很大的内部ROM容量，但还是不能完整的保存一首MP3歌曲。
方案二：此方案采用U盘来储存MP3文件，极大的提高了储存容量。
方案三：此方案采用SD卡来储存MP3文件。采用SPI通讯方式的SD卡不仅读取数据的速度快，而且具有小体积，大容量等特点。
根据本人的实际情况，故采用了方案三。 
1.2	系统设计原理
本设计由STM32最小系统，SD卡的读取模块，TFT控制模块，外扩FLASH模块，触摸屏模块，串口通信模块组成。将要解决SD卡的读取及使用FATFS系统对SD卡的操作、TFT液晶的控制及触摸屏原理、还有图形用户界面GUI的实现等问题。硬件系统方框图如图2-1所示。
基本设计流程是使用STM32系列微控制器，采用FATFS文件系统方式读取SD卡中的MP3文件，并控制MP3解码芯片对MP3文件进行解码播放，并在TFT液晶上显示实时播放情况。
 
图 2-1  硬件系统方框图

1.2.1	中央处理器工作原理
STM32系列是基于CortexM3核的微控制器，它在CortexM3内核的基础上扩展了高性能的外围设备。
CortexM3是ARM公司最新推出的基于ARMv7体系架构的处理器核，具有高性能、低成本、低功耗的特点，专门为嵌入式应用领域设计。
ARMv7 架构采用了Thumb2技术，它是在ARM的Thumb代码压缩技术的基础上发展起来的，并且保持了对现存ARM解决方案完整的代码兼容性。 Thumb2技术比纯ARM代码少使用31%的内存，减小了系统开销，同时能够提供比Thumb技术高出38%的性能。
在中断处理方面，CortexM3集成了嵌套向量中断控制器NVIC(Nested Vectored Interrupt Controller)。NVIC是CortexM3处理器的一个紧耦合部分，可以配置1~240个带有256个优先级、8级抢占优先权的物理中断，为处理器提供出色的异常处理能力。同时，抢占（Preemption）、尾链（Tailchaining）、迟到技术（Latearriving）的使用，大大缩短了异常事件的响应时间。CortexM3异常处理过程中由硬件自动保存和恢复处理器状态，进一步缩短了中断响应时间，降低了软件设计的复杂性。CortexM3体系架构提出了新的单线调试技术，CortexM3处理器的跟踪调试是通过调试访问端口(Debug Access Port，DAP)来实现的。DAP端口可以作为串行线调试端口（SWDP）或串行JTAG调试端口（SWJDP，允许JTAG或SW协议）使用。其中SWDP只需要时钟和数据2个引脚，实现低成本跟踪调试，避免使用多引脚进行JTAG调试，并全面支持RealView编译器和 RealView调试产品。此外CortexM3还具备高度集成化的特点，大大减小了芯片面积，内部集成了许多紧耦合系统外设，合理利用了芯片空间，使系统满足下一代产品的控制需求。其引脚分布如图2-2所示：
 
图2-2 STM32F103VCT6 微控制器引脚分布图

1.2.2	音频解码芯片
VS1003 是一个单片MP3/WMA/MIDI音频解码器和ADPCM编码器。它包含一个高性能，自主产权的低功耗DSP 处理器核VS_DSP4，工作数据存储器，为用户应用提供5KB 的指令RAM 和0.5KB 的数据RAM。串行的控制和数据接口，4 个常规用途的I/O 口，一个UART，也有一个高品质可变采样率的ADC和立体声DAC，还有一个耳机放大器和地线缓冲器，芯片原理图如图2-3所示。其具体特性如下：
（1）能解码 MPEG 1 和MPEG2 音频层 III（CBR+VBR+ABR）；WMA 4.0/4.1/7/8/9 5-384kbps 所有流文件；WAV(PCM+IMAAD-PCM);产生MIDI/SP-MIDI 文件。
（2）对话筒输入或线路输入的音频信号进行IMAADPCM编码。支持 MP3 和WAV 流。
（3）高低音控制，低功耗，单时钟操作12～13MHz，内部PLL锁相环时钟倍频器。
（4）内含高性能片上立体声数模转换器，两声道间无相位差。内含能驱动30欧负载的耳机驱动器，模拟，数字，I/O 单独供电。
（5）为用户代码和数据准备的5.5KB片上RAM，串行的控制，数据接口，可被用作微处理器的从机。
（6）特殊应用的SPI Flash引导，供调试用途的UART接口，新功能可以通过软件和4 GPIO 添加。
 
 图2-3  VS1003芯片原理图
